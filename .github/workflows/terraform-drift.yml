name: Terraform Drift Check (Reusable)

on:
  workflow_call:
    inputs:
      environment_folders:
        description: 'Space-separated list of environment folder names (e.g., "1-dev 2-test 3-prod"). Leave empty to check root directory.'
        required: false
        type: string
        default: ''
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.6.0'
      working_directory:
        description: 'Working directory for the repository (defaults to root)'
        required: false
        type: string
        default: '.'
      check_all_environments:
        description: 'Check all environments in environment_folders (if false, only checks root)'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true

permissions:
  id-token: write  # Required for OIDC
  contents: read   # Required to read the repository contents

jobs:
  prepare-environments:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.filter.outputs.environments }}
    steps:
      - name: Prepare environments list
        id: filter
        run: |
          ENVIRONMENTS=""
          
          if [ "${{ inputs.check_all_environments }}" == "true" ] && [ -n "${{ inputs.environment_folders }}" ]; then
            # Convert space-separated list to JSON array
            ENVIRONMENTS_ARRAY=""
            for env in ${{ inputs.environment_folders }}; do
              if [ -z "$ENVIRONMENTS_ARRAY" ]; then
                ENVIRONMENTS_ARRAY="\"$env\""
              else
                ENVIRONMENTS_ARRAY="$ENVIRONMENTS_ARRAY,\"$env\""
              fi
            done
            ENVIRONMENTS="[$ENVIRONMENTS_ARRAY]"
          else
            # Check root directory only
            ENVIRONMENTS='[""]'
          fi
          
          echo "environments=$ENVIRONMENTS" >> $GITHUB_OUTPUT
          echo "Environments to check: $ENVIRONMENTS"

  check:
    needs: prepare-environments
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.prepare-environments.outputs.environments) }}
      fail-fast: false
    name: Check for terraform drift ${{ matrix.environment != '' && format('in {0}', matrix.environment) || 'in root directory' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Determine Terraform Directory
        id: tf-dir
        run: |
          if [ "${{ matrix.environment }}" != "" ]; then
            TF_DIR="${{ inputs.working_directory }}/${{ matrix.environment }}"
            ENV_NAME="${{ matrix.environment }}"
          else
            TF_DIR="${{ inputs.working_directory }}"
            ENV_NAME="root"
          fi
          echo "directory=$TF_DIR" >> $GITHUB_OUTPUT
          echo "name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "Terraform directory: $TF_DIR"

      - name: Terraform Init
        working-directory: ${{ steps.tf-dir.outputs.directory }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Check for drift
        working-directory: ${{ steps.tf-dir.outputs.directory }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          # Run terraform plan and capture exit code
          terraform plan -no-color -detailed-exitcode
          EXIT_CODE=$?
          
          # Exit code 0 = no changes
          # Exit code 1 = error
          # Exit code 2 = changes detected (drift)
          if [ $EXIT_CODE -eq 2 ]; then
            echo "❌ Drift detected in ${{ steps.tf-dir.outputs.name }}! Infrastructure has changed."
            exit 1
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "❌ Error running terraform plan in ${{ steps.tf-dir.outputs.name }}."
            exit 1
          else
            echo "✅ No drift detected in ${{ steps.tf-dir.outputs.name }}. Infrastructure matches configuration."
          fi
