name: GitOps Kustomize Validate (Reusable)

on:
  workflow_call:
    inputs:
      overlays_path:
        description: 'Path to overlays directory (default: overlays)'
        required: false
        type: string
        default: 'overlays'
      kubectl_version:
        description: 'kubectl version to use (default: latest)'
        required: false
        type: string
        default: 'latest'

jobs:
  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validating YAML syntax..."
          find . -type f \( -name "*.yaml" -o -name "*.yml" \) ! -path "./.git/*" | while read -r file; do
            echo "Checking: $file"
            yq eval '.' "$file" > /dev/null || {
              echo "âŒ Error: Invalid YAML in $file"
              exit 1
            }
          done
          echo "âœ… All YAML files are valid"

  validate-kustomize:
    name: Validate Kustomize Overlays
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      overlays_validated: ${{ steps.validate.outputs.overlays_validated }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ inputs.kubectl_version }}

      - name: Validate overlays (kubectl kustomize + dry-run apply)
        id: validate
        shell: bash
        env:
          OVERLAYS_PATH: ${{ inputs.overlays_path }}
        run: |
          set -euo pipefail

          if [ ! -d "$OVERLAYS_PATH" ]; then
            echo "âŒ Error: overlays_path directory not found: $OVERLAYS_PATH"
            exit 1
          fi

          COUNT=0

          # Validate each overlay folder containing a kustomization file
          for overlay_dir in "$OVERLAYS_PATH"/*; do
            if [ ! -d "$overlay_dir" ]; then
              continue
            fi

            if [ -f "$overlay_dir/kustomization.yaml" ] || [ -f "$overlay_dir/kustomization.yml" ]; then
              OVERLAY_NAME=$(basename "$overlay_dir")
              echo "ðŸ” Validating overlay: $OVERLAY_NAME ($overlay_dir)"

              # 1) Render manifests
              kubectl kustomize "$overlay_dir" > rendered.yaml

              # 2) Client-side validation (no cluster required)
              kubectl apply --dry-run=client -f rendered.yaml >/dev/null

              echo "âœ… Overlay validation passed: $OVERLAY_NAME"
              COUNT=$((COUNT + 1))
            fi
          done

          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ Error: No overlays found under: $OVERLAYS_PATH"
            echo "Expected at least one subdirectory containing kustomization.yaml"
            exit 1
          fi

          echo "overlays_validated=$COUNT" >> "$GITHUB_OUTPUT"
          echo "âœ… Validated $COUNT overlay(s)"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-kustomize]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Create summary
        run: |
          echo "### âœ… Kustomize Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Syntax | ${{ needs.validate-yaml.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kustomize Overlays | ${{ needs.validate-kustomize.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **overlays_path**: \`${{ inputs.overlays_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **overlays validated**: \`${{ needs.validate-kustomize.outputs.overlays_validated || '0' }}\`" >> $GITHUB_STEP_SUMMARY

