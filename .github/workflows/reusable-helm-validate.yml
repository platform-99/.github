name: Helm Chart Validate (Reusable)

on:
  workflow_call:
    inputs:
      chart_path:
        description: 'Path to Helm chart directory'
        required: true
        type: string
      chart_name:
        description: 'Chart name (defaults to directory name)'
        required: false
        type: string
      helm_version:
        description: 'Helm version to use'
        required: false
        type: string
        default: '3.12.0'
      strict_lint:
        description: 'Run helm lint with --strict flag'
        required: false
        type: boolean
        default: false
      validate_dependencies:
        description: 'Validate and build chart dependencies'
        required: false
        type: boolean
        default: true
      values_files:
        description: 'Comma-separated list of values files to validate against'
        required: false
        type: string

jobs:
  validate:
    name: Validate Helm Chart
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    outputs:
      chart_version: ${{ steps.chart-version.outputs.version }}
      chart_name: ${{ steps.chart-name.outputs.name }}
      validation_passed: ${{ steps.validate.outputs.passed }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ inputs.helm_version }}

      - name: Lint Helm chart
        id: lint
        run: |
          echo "ğŸ” Linting Helm chart..."
          LINT_ARGS="${{ inputs.chart_path }}"
          if [ "${{ inputs.strict_lint }}" == "true" ]; then
            LINT_ARGS="$LINT_ARGS --strict"
          fi
          helm lint $LINT_ARGS
          echo "âœ… Helm chart linting passed"

      - name: Extract chart name
        id: chart-name
        run: |
          if [ -n "${{ inputs.chart_name }}" ]; then
            CHART_NAME="${{ inputs.chart_name }}"
          else
            CHART_NAME=$(basename "${{ inputs.chart_path }}")
          fi
          echo "name=$CHART_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Chart name: $CHART_NAME"

      - name: Extract chart version
        id: chart-version
        run: |
          echo "ğŸ“‹ Extracting chart version..."
          VERSION=$(helm show chart ${{ inputs.chart_path }} | grep '^version:' | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            echo "âŒ Error: Could not extract version from Chart.yaml"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Chart version: $VERSION"

      - name: Validate chart dependencies
        id: validate-dependencies
        if: inputs.validate_dependencies
        run: |
          echo "ğŸ” Checking chart dependencies..."
          if [ -f "${{ inputs.chart_path }}/Chart.yaml" ] && grep -q "dependencies:" "${{ inputs.chart_path }}/Chart.yaml"; then
            echo "ğŸ“¦ Building chart dependencies..."
            helm dependency build ${{ inputs.chart_path }}
            echo "âœ… Chart dependencies built successfully"
          else
            echo "â„¹ï¸  No dependencies found in chart"
          fi

      - name: Validate Helm chart templates
        id: template-validate
        run: |
          echo "ğŸ” Validating Helm chart templates..."
          helm template test-release ${{ inputs.chart_path }} --debug --dry-run
          echo "âœ… Helm chart template validation passed"

      - name: Validate with custom values files
        if: inputs.values_files != ''
        run: |
          echo "ğŸ” Validating chart with custom values files..."
          IFS=',' read -ra VALUES_ARGS <<< "${{ inputs.values_files }}"
          VALUES_FLAGS=""
          for values_file in "${VALUES_ARGS[@]}"; do
            VALUES_FLAGS="$VALUES_FLAGS -f $values_file"
          done
          helm template test-release ${{ inputs.chart_path }} $VALUES_FLAGS --debug --dry-run
          echo "âœ… Chart validation with custom values passed"

      - name: Set validation result
        id: validate
        if: always()
        run: |
          if [ "${{ steps.lint.outcome }}" == "success" ] && \
             [ "${{ steps.template-validate.outcome }}" == "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All Helm chart validations passed"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Helm chart validation failed"
            exit 1
          fi

      - name: Validation summary
        if: always()
        run: |
          echo "### âœ… Helm Chart Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chart.yaml Syntax | ${{ steps.chart-version.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ inputs.validate_dependencies && (steps.validate-dependencies.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed') || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ steps.lint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Template Validation | ${{ steps.template-validate.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart**: ${{ steps.chart-name.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.chart-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: \`${{ inputs.chart_path }}\`" >> $GITHUB_STEP_SUMMARY

