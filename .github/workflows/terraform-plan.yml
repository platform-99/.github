name: Terraform Plan (Reusable)

on:
  workflow_call:
    inputs:
      environment_folders:
        description: 'Space-separated list of environment folder names (e.g., "1-dev 2-test 3-prod")'
        required: true
        type: string
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.14.3'
      working_directory:
        description: 'Working directory for the repository (defaults to root)'
        required: false
        type: string
        default: '.'
      skip_validation:
        description: 'Skip single environment validation (allow multiple environments)'
        required: false
        type: boolean
        default: false
      auto_format:
        description: 'Automatically format Terraform files and commit fixes'
        required: false
        type: boolean
        default: true
      comment_on_pr:
        description: 'Comment Terraform plan output on pull requests'
        required: false
        type: boolean
        default: true
      selected_environment:
        description: 'Selected environment for workflow_dispatch (optional)'
        required: false
        type: string
      configure_git_for_private_modules:
        description: 'Configure Git authentication for private Terraform modules (requires GH_APP_ID and GH_APP_PRIVATE_KEY secrets)'
        required: false
        type: boolean
        default: false
      private_module_owner:
        description: 'GitHub organization name where private Terraform modules are located (defaults to repository owner). The GitHub App must be installed on this organization.'
        required: false
        type: string
      configure_aws_credentials:
        description: 'Configure AWS credentials using OIDC (requires AWS_ROLE_ARN secret)'
        required: false
        type: boolean
        default: false
      aws_region:
        description: 'AWS region for credential configuration (default: ca-central-1)'
        required: false
        type: string
        default: 'ca-central-1'
      kv_names:
        description: 'Space-separated list of Azure Key Vault names corresponding to environment_folders (e.g., "kv-dev-wb1a2b3c4 kv-test-wb4d5e6f7g8 kv-prod-wb7h8i9j0k1"). Order must match environment_folders. If not provided, Key Vault secret injection will be skipped. Secrets in Key Vault should be named with TF-VAR- prefix (e.g., TF-VAR-db-password).'
        required: false
        type: string
    secrets:
      AZURE_CLIENT_ID:
        description: 'Azure Client ID for authenticating to Azure'
        required: true
      AZURE_TENANT_ID:
        description: 'Azure Tenant ID for authenticating to Azure'
        required: true
      AZURE_SUBSCRIPTION_ID:
        description: 'Azure Subscription ID for authenticating to Azure'
        required: true
      GH_APP_ID:
        description: 'GitHub App ID for authenticating to private Terraform modules (required if configure_git_for_private_modules is true)'
        required: false
      GH_APP_PRIVATE_KEY:
        description: 'GitHub App private key for authenticating to private Terraform modules (required if configure_git_for_private_modules is true)'
        required: false
      AWS_ROLE_ARN:
        description: 'AWS IAM role ARN to assume for OIDC authentication (required if configure_aws_credentials is true)'
        required: false

permissions:
  id-token: write       # Required for OIDC
  contents: write       # Required to commit formatting fixes
  pull-requests: write  # Required to comment on PRs

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT_FOLDERS: ${{ inputs.environment_folders }}
    outputs:
      environments: ${{ steps.filter.outputs.environments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.head_ref || github.ref }}
          fetch-depth: 0  # Fetch full history to access previous commits

      - name: Detect modified environments and validate
        id: filter
        uses: platform-99/.github/.github/actions/detect-modified-environments@main
        with:
          environment_folders: ${{ inputs.environment_folders }}
          selected_environment: ${{ inputs.selected_environment }}
          validate_single_environment: ${{ !inputs.skip_validation }}
          base_ref: ${{ github.event.pull_request.base.sha || github.event.before }}
          head_ref: ${{ github.event.pull_request.head.sha || github.sha }}

  plan:
    needs: detect-changes
    if: needs.detect-changes.outputs.environments != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.environments) }}
      fail-fast: false
    name: Create a plan for ${{ matrix.environment }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_DIR: ${{ matrix.environment }}
      ARM_USE_OIDC: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha || github.head_ref || github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Configure Git Authentication for Private Modules
        if: inputs.configure_git_for_private_modules
        uses: platform-99/.github/.github/actions/github-private-modules-auth@main
        with:
          configure_git_for_private_modules: ${{ inputs.configure_git_for_private_modules }}
          gh_app_id: ${{ secrets.GH_APP_ID }}
          gh_app_private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          private_module_owner: ${{ inputs.private_module_owner }}
          repository_owner: ${{ github.repository_owner }}

      - name: Check Terraform Formatting
        id: fmt
        working-directory: ${{ inputs.working_directory }}
        run: terraform fmt -check -recursive
        continue-on-error: true
  
      - name: Fix Terraform Formatting
        if: steps.fmt.outcome == 'failure' && inputs.auto_format
        working-directory: ${{ inputs.working_directory }}
        run: terraform fmt -recursive

      - name: Commit Formatting Fixes
        if: steps.fmt.outcome == 'failure' && inputs.auto_format && github.event_name == 'pull_request'
        working-directory: ${{ inputs.working_directory }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "fix: auto-format terraform files [skip ci]" || exit 0
          git push

      - name: Validate AWS credentials secret
        if: inputs.configure_aws_credentials
        run: |
          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "‚ùå Error: 'AWS_ROLE_ARN' secret is required when 'configure_aws_credentials' is true"
            exit 1
          fi
          echo "‚úÖ AWS credentials secret validated"

      - name: Configure AWS credentials
        if: inputs.configure_aws_credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}/${{ env.TF_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: terraform init

      - name: Inject Terraform Variables from Azure Key Vault
        if: inputs.kv_names != null && inputs.kv_names != ''
        uses: platform-99/.github/.github/actions/azure-keyvault-inject-secrets@main
        with:
          environment_folders: ${{ inputs.environment_folders }}
          kv_names: ${{ inputs.kv_names }}
          current_environment: ${{ env.TF_DIR }}
          azure_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Plan
        id: plan
        working-directory: ${{ inputs.working_directory }}/${{ env.TF_DIR }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Terraform Plan Output
        id: plan-output
        if: steps.plan.outcome == 'success'
        working-directory: ${{ inputs.working_directory }}/${{ env.TF_DIR }}
        run: |
          terraform show -no-color tfplan > plan_output.txt || echo "No changes to infrastructure." > plan_output.txt

      - name: Comment PR
        if: github.event_name == 'pull_request' && steps.plan.outcome == 'success' && inputs.comment_on_pr
        working-directory: ${{ inputs.working_directory }}/${{ env.TF_DIR }}
        run: |
          PLAN=$(cat plan_output.txt 2>/dev/null || echo "No changes to infrastructure.")
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Write comment body to a file to avoid "Argument list too long" error
          cat > comment_body.txt <<EOF
          ## Terraform Plan for ${{ env.TF_DIR }} üìñ
          
          <details><summary>Show Plan</summary>
          
          \`\`\`
          $PLAN
          \`\`\`
          
          </details>
          
          üìù The plan was generated in the [Github Actions Workflow Run]($WORKFLOW_RUN_URL)
          EOF
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment_body.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
